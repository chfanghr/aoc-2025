type v2 = { x : int; y : int }
type v2_diff = { d_x : int; d_y : int }
type box = { b_a : v2; b_b : v2 }

let pair_of_v2 v = (v.x, v.y)
let swap_v2 v = { x = v.y; y = v.x }
let option_alt l r = match (l, r) with Some x, _ -> Some x | _, y -> y
let eq_v2 l r = l.x == r.x && l.y == r.y

let min_v2 v_l v_r =
  if Pair.compare Int.compare Int.compare (pair_of_v2 v_l) (pair_of_v2 v_r) < 0
  then v_l
  else v_r

let parser =
  let open Angstrom in
  let spaces = char ' ' in
  let newline = char '\n' in
  let uint =
    let* digits = take_while1 (function '0' .. '9' -> true | _ -> false) in
    let m_int = int_of_string_opt digits in
    Option.fold ~none:(fail "failed to convert digits to in") ~some:return m_int
  in
  let row =
    let* x = uint in
    let* _ = char ',' in
    let* y = uint in
    return { x; y }
  in
  let rows = sep_by1 newline row in
  rows <* many (spaces <|> newline)

let parse =
  let open Angstrom in
  parse_string ~consume:Consume.All parser

let v2_minus l r = { d_x = l.x - r.x; d_y = l.y - r.y }

let area_of_box b =
  let d = v2_minus b.b_a b.b_b in
  abs ((d.d_x + 1) * (d.d_y + 1))

(* Naive *)

let naive_biggest_box_area coords =
  let box_areas =
    let ( let* ) m body = List.concat_map body m in
    let return x = [ x ] in
    let* a = coords in
    let* b = coords in
    let box = { b_a = a; b_b = b } in
    return (area_of_box box)
  in
  let maximum = List.fold_left max 0 in
  maximum box_areas

(* Graham Scan *)

type direction = TurnLeft | TurnRight | GoStraight

let turning p1 p2 p3 =
  let area =
    ((p2.x - p1.x) * (p3.y - p1.y)) - ((p2.y - p1.y) * (p3.x - p1.x))
  in
  let cmp = Int.compare area 0 in
  if cmp < 0 then TurnRight else if cmp == 0 then GoStraight else TurnLeft

let bottom_left vs =
  let vs' = List.map swap_v2 vs in
  let min_p = List.fold_left min_v2 (List.hd vs') (List.tl vs') in
  swap_v2 min_p

let sort_on_polar = function
  | [] -> []
  | ps ->
      let origin = bottom_left ps in
      let polar { x; y } =
        Float.atan2 (Float.of_int (y - origin.y)) (Float.of_int (x - origin.x))
      in
      let rest = List.filter (Fun.compose not (eq_v2 origin) ) ps in
      let sort_on f =
        let comp x y = compare (f x) (f y) in
        List.sort comp
      in
      origin :: sort_on polar rest

let graham_scan =
  let rec go = function
    | (x :: xs as xs'), y :: z :: ys ->
        if turning x y z == TurnLeft then go (y :: xs', z :: ys)
        else go (xs, x :: z :: ys)
    | xs, [ y ] -> y :: xs
    | xs, [] -> xs
    | _ -> failwith "how"
  in
  function [] -> [] | p :: ps -> go ([ p ], ps)

let convex  = Fun.compose graham_scan sort_on_polar

(* Rotating calipers *)

(* TODO: implement this shit *)

(* Solution *)

let pt1_naive = Fun.compose (Result.map naive_biggest_box_area) parse

let pt1_better = Fun.compose (Result.map (Fun.compose naive_biggest_box_area convex)) parse

(* Inputs *)

let example_input = "7,1\n11,1\n11,7\n9,7\n9,5\n2,5\n2,3\n7,3\n"

let input =
  "97668,50157\n\
   97668,51385\n\
   98359,51385\n\
   98359,52575\n\
   97665,52575\n\
   97665,53785\n\
   97626,53785\n\
   97626,55034\n\
   97938,55034\n\
   97938,56284\n\
   98077,56284\n\
   98077,57485\n\
   97804,57485\n\
   97804,58599\n\
   97082,58599\n\
   97082,59720\n\
   96522,59720\n\
   96522,61011\n\
   96752,61011\n\
   96752,62293\n\
   96842,62293\n\
   96842,63219\n\
   95629,63219\n\
   95629,64637\n\
   96118,64637\n\
   96118,65759\n\
   95613,65759\n\
   95613,66948\n\
   95301,66948\n\
   95301,67785\n\
   94102,67785\n\
   94102,69157\n\
   94239,69157\n\
   94239,70372\n\
   93956,70372\n\
   93956,71497\n\
   93462,71497\n\
   93462,72391\n\
   92522,72391\n\
   92522,73588\n\
   92169,73588\n\
   92169,74677\n\
   91605,74677\n\
   91605,75577\n\
   90735,75577\n\
   90735,76527\n\
   89962,76527\n\
   89962,77334\n\
   88997,77334\n\
   88997,78807\n\
   88960,78807\n\
   88960,79327\n\
   87630,79327\n\
   87630,80406\n\
   87039,80406\n\
   87039,81692\n\
   86671,81692\n\
   86671,82145\n\
   85345,82145\n\
   85345,83121\n\
   84613,83121\n\
   84613,84404\n\
   84177,84404\n\
   84177,84975\n\
   83027,84975\n\
   83027,85494\n\
   81855,85494\n\
   81855,86592\n\
   81204,86592\n\
   81204,87652\n\
   80495,87652\n\
   80495,87676\n\
   78965,87676\n\
   78965,88740\n\
   78250,88740\n\
   78250,89295\n\
   77157,89295\n\
   77157,89838\n\
   76067,89838\n\
   76067,90648\n\
   75150,90648\n\
   75150,91244\n\
   74096,91244\n\
   74096,92217\n\
   73250,92217\n\
   73250,92230\n\
   71882,92230\n\
   71882,93396\n\
   71109,93396\n\
   71109,93796\n\
   69948,93796\n\
   69948,94048\n\
   68730,94048\n\
   68730,94809\n\
   67727,94809\n\
   67727,94758\n\
   66408,94758\n\
   66408,95089\n\
   65245,95089\n\
   65245,96007\n\
   64268,96007\n\
   64268,96250\n\
   63068,96250\n\
   63068,96202\n\
   61799,96202\n\
   61799,96958\n\
   60733,96958\n\
   60733,97436\n\
   59585,97436\n\
   59585,96828\n\
   58233,96828\n\
   58233,97534\n\
   57121,97534\n\
   57121,97396\n\
   55877,97396\n\
   55877,98131\n\
   54733,98131\n\
   54733,97773\n\
   53479,97773\n\
   53479,98175\n\
   52283,98175\n\
   52283,98456\n\
   51067,98456\n\
   51067,97614\n\
   49842,97614\n\
   49842,98235\n\
   48618,98235\n\
   48618,97487\n\
   47434,97487\n\
   47434,98106\n\
   46176,98106\n\
   46176,97992\n\
   44959,97992\n\
   44959,97234\n\
   43825,97234\n\
   43825,97343\n\
   42587,97343\n\
   42587,97475\n\
   41328,97475\n\
   41328,97086\n\
   40161,97086\n\
   40161,96999\n\
   38929,96999\n\
   38929,96224\n\
   37868,96224\n\
   37868,96534\n\
   36518,96534\n\
   36518,95278\n\
   35629,95278\n\
   35629,95798\n\
   34176,95798\n\
   34176,94596\n\
   33315,94596\n\
   33315,94217\n\
   32167,94217\n\
   32167,94017\n\
   30938,94017\n\
   30938,93419\n\
   29875,93419\n\
   29875,93320\n\
   28572,93320\n\
   28572,92335\n\
   27707,92335\n\
   27707,91771\n\
   26634,91771\n\
   26634,91292\n\
   25508,91292\n\
   25508,90722\n\
   24430,90722\n\
   24430,89993\n\
   23451,89993\n\
   23451,89058\n\
   22622,89058\n\
   22622,88249\n\
   21717,88249\n\
   21717,87950\n\
   20423,87950\n\
   20423,87200\n\
   19461,87200\n\
   19461,86247\n\
   18673,86247\n\
   18673,85600\n\
   17622,85600\n\
   17622,84972\n\
   16535,84972\n\
   16535,83818\n\
   15957,83818\n\
   15957,83194\n\
   14847,83194\n\
   14847,82131\n\
   14198,82131\n\
   14198,81126\n\
   13499,81126\n\
   13499,80183\n\
   12731,80183\n\
   12731,79509\n\
   11615,79509\n\
   11615,78372\n\
   11092,78372\n\
   11092,77532\n\
   10163,77532\n\
   10163,76010\n\
   10248,76010\n\
   10248,75053\n\
   9507,75053\n\
   9507,74092\n\
   8762,74092\n\
   8762,73055\n\
   8135,73055\n\
   8135,72149\n\
   7253,72149\n\
   7253,70795\n\
   7249,70795\n\
   7249,70085\n\
   5902,70085\n\
   5902,68911\n\
   5525,68911\n\
   5525,67490\n\
   5790,67490\n\
   5790,66691\n\
   4469,66691\n\
   4469,65248\n\
   4903,65248\n\
   4903,64335\n\
   3774,64335\n\
   3774,63137\n\
   3507,63137\n\
   3507,61856\n\
   3575,61856\n\
   3575,60662\n\
   3352,60662\n\
   3352,59529\n\
   2838,59529\n\
   2838,58343\n\
   2546,58343\n\
   2546,57131\n\
   2395,57131\n\
   2395,55892\n\
   2480,55892\n\
   2480,54676\n\
   2452,54676\n\
   2452,53518\n\
   1692,53518\n\
   1692,52280\n\
   1887,52280\n\
   1887,51047\n\
   2466,51047\n\
   2466,50147\n\
   94584,50147\n\
   94584,48634\n\
   2325,48634\n\
   2325,47435\n\
   2529,47435\n\
   2529,46159\n\
   1677,46159\n\
   1677,45037\n\
   2751,45037\n\
   2751,43735\n\
   2074,43735\n\
   2074,42540\n\
   2355,42540\n\
   2355,41440\n\
   3136,41440\n\
   3136,40187\n\
   3040,40187\n\
   3040,39003\n\
   3312,39003\n\
   3312,37702\n\
   3141,37702\n\
   3141,36629\n\
   3850,36629\n\
   3850,35406\n\
   4019,35406\n\
   4019,34280\n\
   4503,34280\n\
   4503,33068\n\
   4742,33068\n\
   4742,32005\n\
   5379,32005\n\
   5379,30924\n\
   5950,30924\n\
   5950,29889\n\
   6610,29889\n\
   6610,28717\n\
   6971,28717\n\
   6971,27573\n\
   7409,27573\n\
   7409,26669\n\
   8292,26669\n\
   8292,25449\n\
   8608,25449\n\
   8608,24676\n\
   9669,24676\n\
   9669,23306\n\
   9786,23306\n\
   9786,22403\n\
   10628,22403\n\
   10628,21705\n\
   11733,21705\n\
   11733,20341\n\
   11945,20341\n\
   11945,19857\n\
   13281,19857\n\
   13281,18293\n\
   13312,18293\n\
   13312,17548\n\
   14319,17548\n\
   14319,16511\n\
   15002,16511\n\
   15002,16236\n\
   16458,16236\n\
   16458,15367\n\
   17296,15367\n\
   17296,14521\n\
   18158,14521\n\
   18158,13110\n\
   18542,13110\n\
   18542,13065\n\
   20086,13065\n\
   20086,11920\n\
   20724,11920\n\
   20724,10924\n\
   21504,10924\n\
   21504,10871\n\
   22957,10871\n\
   22957,9785\n\
   23686,9785\n\
   23686,9422\n\
   24893,9422\n\
   24893,8528\n\
   25771,8528\n\
   25771,8112\n\
   26930,8112\n\
   26930,7439\n\
   27946,7439\n\
   27946,7070\n\
   29117,7070\n\
   29117,6038\n\
   29976,6038\n\
   29976,5771\n\
   31192,5771\n\
   31192,4984\n\
   32190,4984\n\
   32190,4519\n\
   33326,4519\n\
   33326,4219\n\
   34520,4219\n\
   34520,4482\n\
   35883,4482\n\
   35883,3439\n\
   36843,3439\n\
   36843,3095\n\
   38020,3095\n\
   38020,2870\n\
   39227,2870\n\
   39227,3158\n\
   40535,3158\n\
   40535,2565\n\
   41659,2565\n\
   41659,2852\n\
   42936,2852\n\
   42936,2524\n\
   44112,2524\n\
   44112,2000\n\
   45279,2000\n\
   45279,1788\n\
   46488,1788\n\
   46488,2310\n\
   47739,2310\n\
   47739,2367\n\
   48950,2367\n\
   48950,1804\n\
   50159,1804\n\
   50159,2234\n\
   51368,2234\n\
   51368,2144\n\
   52585,2144\n\
   52585,2549\n\
   53771,2549\n\
   53771,2273\n\
   55012,2273\n\
   55012,2455\n\
   56214,2455\n\
   56214,2142\n\
   57493,2142\n\
   57493,3027\n\
   58579,3027\n\
   58579,3427\n\
   59731,3427\n\
   59731,2947\n\
   61082,2947\n\
   61082,3867\n\
   62107,3867\n\
   62107,4342\n\
   63227,4342\n\
   63227,3931\n\
   64621,3931\n\
   64621,4462\n\
   65733,4462\n\
   65733,5072\n\
   66808,5072\n\
   66808,5293\n\
   68029,5293\n\
   68029,5570\n\
   69240,5570\n\
   69240,6136\n\
   70329,6136\n\
   70329,6925\n\
   71305,6925\n\
   71305,7721\n\
   72262,7721\n\
   72262,8355\n\
   73294,8355\n\
   73294,8527\n\
   74598,8527\n\
   74598,9036\n\
   75720,9036\n\
   75720,10333\n\
   76330,10333\n\
   76330,10765\n\
   77501,10765\n\
   77501,11424\n\
   78523,11424\n\
   78523,12187\n\
   79469,12187\n\
   79469,13065\n\
   80319,13065\n\
   80319,13864\n\
   81229,13864\n\
   81229,14274\n\
   82492,14274\n\
   82492,15569\n\
   82946,15569\n\
   82946,15997\n\
   84228,15997\n\
   84228,16975\n\
   84972,16975\n\
   84972,18086\n\
   85559,18086\n\
   85559,18601\n\
   86820,18601\n\
   86820,19675\n\
   87442,19675\n\
   87442,20608\n\
   88231,20608\n\
   88231,21531\n\
   89038,21531\n\
   89038,22646\n\
   89577,22646\n\
   89577,23868\n\
   89936,23868\n\
   89936,24672\n\
   90934,24672\n\
   90934,25781\n\
   91453,25781\n\
   91453,26818\n\
   92092,26818\n\
   92092,27910\n\
   92630,27910\n\
   92630,28912\n\
   93351,28912\n\
   93351,30291\n\
   93269,30291\n\
   93269,31123\n\
   94390,31123\n\
   94390,32350\n\
   94611,32350\n\
   94611,33635\n\
   94637,33635\n\
   94637,34545\n\
   95707,34545\n\
   95707,35695\n\
   96123,35695\n\
   96123,36876\n\
   96442,36876\n\
   96442,38138\n\
   96445,38138\n\
   96445,39253\n\
   97013,39253\n\
   97013,40456\n\
   97229,40456\n\
   97229,41635\n\
   97573,41635\n\
   97573,42864\n\
   97628,42864\n\
   97628,44148\n\
   97188,44148\n\
   97188,45339\n\
   97389,45339\n\
   97389,46492\n\
   98162,46492\n\
   98162,47736\n\
   97751,47736\n\
   97751,48931\n\
   98481,48931\n\
   98481,50157\n\
  \    "
