(* Parser *)

type cell = Start | Beam | Splitter | Empty
type grid = cell array array

let parser =
  let open Angstrom in
  let cell =
    let start = char 'S' *> return Start in
    let beam = char '|' *> return Beam in
    let splitter = char '^' *> return Splitter in
    let empty = char '.' *> return Empty in
    start <|> beam <|> splitter <|> empty
  in
  let grid =
    let row = many1 cell in
    let newline = char '\n' in
    let grid_raw = sep_by1 newline row in
    let check_grid g =
      let line_length = List.length (List.hd g) in
      let all_lines_have_same_length =
        List.for_all (fun l -> List.length l == line_length) g
      in

      let exactly_one_start =
        List.fold_left
          (fun c cell -> match cell with Start -> c + 1 | _ -> c)
          (0 : int)
          (List.flatten g)
        == 1
      in
      all_lines_have_same_length && exactly_one_start
    in
    let mk_grid g =
      if check_grid g then return (Array.of_list (List.map Array.of_list g))
      else fail "all lines must have the same length"
    in
    let finalize = skip_many newline *> end_of_input in
    grid_raw >>= mk_grid <* finalize
  in
  grid

let parse =
  let open Angstrom in
  parse_string ~consume:Consume.All parser

(* Solver *)

type state = { tip_cols : int list; tip_row : int; count : int }

let initial_state g =
  Option.to_result ~none:"start not found, cannot construct initial state"
    ((Array.find_mapi (fun row_idx row ->
          Option.map
            (fun col_idx ->
              { tip_cols = [ col_idx ]; tip_row = row_idx; count = 0 })
            (Array.find_index (( == ) Start) row)))
       g)

let next_state g s =
  if Array.length g == s.tip_row + 1 then None
  else
    Some
      (let tip_row = s.tip_row + 1 in
       let tips_and_splits =
         let next_tips col_idx =
           if g.(tip_row).(col_idx) == Splitter then
             (true, [ col_idx - 1; col_idx + 1 ])
           else (false, [ col_idx ])
         in

         List.map next_tips s.tip_cols
       in
       let tip_cols =
         let finalize_tips cols =
           List.filter
             (fun idx -> idx >= 0 && idx < Array.length g.(0))
             (List.sort_uniq Int.compare cols)
         in
         finalize_tips (List.flatten (List.map snd tips_and_splits))
       in
       let count = s.count + List.length (List.filter fst tips_and_splits) in
       { tip_cols; tip_row; count })

let solve g =
  let rec go s = Option.fold ~none:s.count ~some:go (next_state g s) in
  go

let run inp =
  let open Result.Syntax in
  let* g = parse inp in
  let* s = initial_state g in
  Ok (solve g s)

(* Inputs *)

let example_input =
  ".......S.......\n\
   ...............\n\
   .......^.......\n\
   ...............\n\
   ......^.^......\n\
   ...............\n\
   .....^.^.^.....\n\
   ...............\n\
   ....^.^...^....\n\
   ...............\n\
   ...^.^...^.^...\n\
   ...............\n\
   ..^...^.....^..\n\
   ...............\n\
   .^.^.^.^.^...^.\n\
   ..............."

let input =
  "......................................................................S......................................................................\n\
   .............................................................................................................................................\n\
   ......................................................................^......................................................................\n\
   .............................................................................................................................................\n\
   .....................................................................^.^.....................................................................\n\
   .............................................................................................................................................\n\
   ....................................................................^.^.^....................................................................\n\
   .............................................................................................................................................\n\
   ...................................................................^...^.^...................................................................\n\
   .............................................................................................................................................\n\
   ..................................................................^.^.....^..................................................................\n\
   .............................................................................................................................................\n\
   .................................................................^.^...^.^.^.................................................................\n\
   .............................................................................................................................................\n\
   ................................................................^...^.^.^.^.^................................................................\n\
   .............................................................................................................................................\n\
   ...............................................................^.^...^.....^.^...............................................................\n\
   .............................................................................................................................................\n\
   ..............................................................^.^.^.^.^...^.^.^..............................................................\n\
   .............................................................................................................................................\n\
   .............................................................^...^.^...^.......^.............................................................\n\
   .............................................................................................................................................\n\
   ............................................................^.^.^.^.^.^...^.^.^.^............................................................\n\
   .............................................................................................................................................\n\
   ...........................................................^.^.^.^.^.^...^.^...^.^...........................................................\n\
   .............................................................................................................................................\n\
   ..........................................................^.......^...^.^.^.^.^.^.^..........................................................\n\
   .............................................................................................................................................\n\
   .........................................................^...^...^.....^...^.......^.........................................................\n\
   .............................................................................................................................................\n\
   ........................................................^...^.^.^.^.^...^.^.^.^.^...^........................................................\n\
   .............................................................................................................................................\n\
   .......................................................^.....^.....^.^.....^.^.^.^...^.......................................................\n\
   .............................................................................................................................................\n\
   ......................................................^.^.^.....^.^.^...^...^...^...^.^......................................................\n\
   .............................................................................................................................................\n\
   .....................................................^.^.^.^.^...^.^.....^.^.^.^.^.^.^.^.....................................................\n\
   .............................................................................................................................................\n\
   ....................................................^.^.^.^.....^.^.^.....^.^.^...^.^.^.^....................................................\n\
   .............................................................................................................................................\n\
   ...................................................^...^...^...^.^...^.^.^.^.^.^.^.^...^.^...................................................\n\
   .............................................................................................................................................\n\
   ..................................................^.^...^.^.^.^...^.^.^...^...^.^...^.^...^..................................................\n\
   .............................................................................................................................................\n\
   .................................................^.^.^.^.^.^.....^...^.^.^.^.^.^...^...^.^.^.................................................\n\
   .............................................................................................................................................\n\
   ................................................^.^.^.....^.........^.^...^.^.....^.^.^.^.^.^................................................\n\
   .............................................................................................................................................\n\
   ...............................................^...^.^.^.^.^.^...^...^...^.^.^.^.^.....^.^...^...............................................\n\
   .............................................................................................................................................\n\
   ..............................................^.^.^.^...^.^...^.....^.^...^.^...^...^.....^.^.^..............................................\n\
   .............................................................................................................................................\n\
   .............................................^.^...^...^.^.^.^.^.^...^...^.^...^.....^...^.^.^.^.............................................\n\
   .............................................................................................................................................\n\
   ............................................^.^...^.....^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^.^............................................\n\
   .............................................................................................................................................\n\
   ...........................................^...^.^.^.^.^.^.....^...........^.^...^...^.^.^.^.....^...........................................\n\
   .............................................................................................................................................\n\
   ..........................................^.^.....^.^.....^.....^.....^...^.^...^...^.^.^.^.^...^.^..........................................\n\
   .............................................................................................................................................\n\
   .........................................^.....^.^.^...^.^.^.^.^.^.^.....^...^.^.^...^.^.^.^.^.^.^.^.........................................\n\
   .............................................................................................................................................\n\
   ........................................^...^.^.^...^.^.^.^.^.....^.^.^.^.^...^...^.......^.^.^.^...^........................................\n\
   .............................................................................................................................................\n\
   .......................................^...^.^.^...^...^.^...^.^.^.^...^.....^.....^...^.^.^.^.^.^.^.^.......................................\n\
   .............................................................................................................................................\n\
   ......................................^.^.^.^.^.^.^.^.^.^...^...^...^.^.^.^.^.^.^.^.^...^.^.^.^...^.^.^......................................\n\
   .............................................................................................................................................\n\
   .....................................^.^.^...^.^.^.^.^.^.^.^...^.^...^.^...^.^.....^...^.....^.^...^.^.^.....................................\n\
   .............................................................................................................................................\n\
   ....................................^.^.^.^.^.^.^.......^...^.^.^.^.^.^.^.^.^.^.....^.^.^...^.^.^.^.^.^.^....................................\n\
   .............................................................................................................................................\n\
   ...................................^.^.....^...^...^.^.^.^.^...^.^.^.....^.^...^...^.^.........^...^.^.^.^...................................\n\
   .............................................................................................................................................\n\
   ..................................^.^.^.....^.^.^.........^.^.^.^...^.......^...^.^.^.^.^.......^.^.^...^.^..................................\n\
   .............................................................................................................................................\n\
   .................................^.....^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.....^.^...^.^.^.^.^.^.^.^.^.^...^.................................\n\
   .............................................................................................................................................\n\
   ................................^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.^.^.^................................\n\
   .............................................................................................................................................\n\
   ...............................^...^.^.....^.........^...^.....^.^.^...^.^.....^.....^.^.^.^.^...^.^.^.^.^.^.^...............................\n\
   .............................................................................................................................................\n\
   ..............................^...^.....^.^.^.^...^.^.^.^.....^.^.^...^...^...^...^.....^.^.^.^.^.^.^.^.^.....^..............................\n\
   .............................................................................................................................................\n\
   .............................^.^...^.^...^.^.^.^.^.^.^.^...^.....^.^...^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^...^.^.............................\n\
   .............................................................................................................................................\n\
   ............................^...^.^.^...^.^.^.^.^.^.^.^...^.^...^.^.^...^.^...^.^.^.^.^.^.^.^.^.......^...^.^.^.^............................\n\
   .............................................................................................................................................\n\
   ...........................^.....^...^...^.^.^.^.^.^.^...^.^.........^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.....^.^.^.^...........................\n\
   .............................................................................................................................................\n\
   ..........................^.^.^...^.^.^.^.^.....^...^.^.^...^...^.^.^.^...^.^.^...^.^.^.^.....^.^.....^...^.^.^.^.^..........................\n\
   .............................................................................................................................................\n\
   .........................^.^.........^.^.....^.^.....^.....^...^.^...^.^...^.^.....^.^.^...^.^.^...^.^...^.^.^...^.^.........................\n\
   .............................................................................................................................................\n\
   ........................^.^.^...^.^.^.^.....^.^.^.....^...^.^.^...^.^.^.....^.^.^...^.^.^.^.....^.^.^...^.^.^.^.^...^........................\n\
   .............................................................................................................................................\n\
   .......................^...^.^...^.^.^.^.......^.^.^.....^.^.^.^.^.....^.^.^.^.....^.^.^.^.^...^...^.^.^...^...^.^.^.^.......................\n\
   .............................................................................................................................................\n\
   ......................^.^...^.^...^.^.^.^...^...^...^.^.^.^...^.^.^...^...^...^.^.^.^.......^.^...^...^.^...^.^...^.^.^......................\n\
   .............................................................................................................................................\n\
   .....................^.^.^.^.^.^...^.^.^.^.^.^.^.....^.^...^.^.^.^...^.^.^.^...^.^.^...^.^...^.........^.....^.^...^.^.^.....................\n\
   .............................................................................................................................................\n\
   ....................^.^.^.^...^...^.^...^...^...^.^...^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.....^...^...^...^...^.^.^.......^....................\n\
   .............................................................................................................................................\n\
   ...................^...^.^.^.^.^.^.....^.^...^...^.^.^.........^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.......^.^.^.......^...................\n\
   .............................................................................................................................................\n\
   ..................^.......^...^...^.^.^.^...^.........^...^.^.^.....^.......^...^...^.....^.^.^.^.^.^.^.^...^.^...^.^.^.^.^..................\n\
   .............................................................................................................................................\n\
   .................^.^.^.^.^.^.^.^.^.....^.^...^.^.^.^...^.^.^...^.^.^...^...^.^...^.^.^.^.^.^.....^.^.^.^.^...^.....^.^...^.^.................\n\
   .............................................................................................................................................\n\
   ................^.^.^.^.^.^.^...^...^.^.^.^...^.....^.^.^...^.^.^.....^.^.^.....^.^...^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^................\n\
   .............................................................................................................................................\n\
   ...............^.^.....^.^.^.^.^.......^.^.^.^.^.^.^...^.^.^.......^.^...^.^...^.^.^.^...^...^.^.^.^...^.^.^...^.^.^.^.....^.^...............\n\
   .............................................................................................................................................\n\
   ..............^...^...^.^.^.^.^.....^.^...^.^.^.^.^.^.^.^...^.....^...^.^.^.....^.^.^.^.....^.^...^.^.^.^.^.^.^.....^.^...^.^.^..............\n\
   .............................................................................................................................................\n\
   .............^.^.....^.^.^.^.^...^.....^.^.....^.^.^.^...^.^.........^.....^.....^.^...^...^.^.^...^.^.....^.^.^...^.^.^.^.^.^.^.............\n\
   .............................................................................................................................................\n\
   ............^.^...^...^.^.........^.^.^...^.^.^.^.^.^.....^.^...^.^.........^.^...^.....^.^.....^...^.^.^.^.^.^.^.....^.^...^.^.^............\n\
   .............................................................................................................................................\n\
   ...........^...^...^...^.^.^...^...^...^.^.^.^...^.....^...^.^.^.....^.....^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.......^.^...........\n\
   .............................................................................................................................................\n\
   ..........^...^.^...^...^.^.....^...^.^...^.^.^.....^.^.^.^...^.^...^.^.^.^...^...^...^...^.^.^.^.^.^.^...^.^.^.^.....^...^.^.^.^.^..........\n\
   .............................................................................................................................................\n\
   .........^.^...^.^.^.^...^...^...........^.^...^...^.^...^.^.^.^...^.^.^.^.....^.^.....^.^.^.^...^.^.^.....^...^.^.^.^.^.^.^.^.^...^.........\n\
   .............................................................................................................................................\n\
   ........^...^.^...^.^...^...^.^.^.^.^.^...^.^.....^.^.^.....^.^...^.^.^.....^.....^.^.^.^.^...^.....^...^...^.^.^...^...^...^...^...^........\n\
   .............................................................................................................................................\n\
   .......^.^.....^...^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.......^.^.^.^.^.^.........^...^.^.^.^.........^.^.^.^.^.....^.^.^.^.^.....^.^.^.......\n\
   .............................................................................................................................................\n\
   ......^...^.^.^...^.^.^.^...^.^...^...^.^.^.....^.^.^...^.....^.^.^...^.^.^.....^.^.^.^.^.^.^.^.....^.^.......^.^.^.^.^.^.^.^...^.^...^......\n\
   .............................................................................................................................................\n\
   .....^.^.......^.^.^.^.^.^...^.^.^...........^.^...^...^.^...^.......^.^.....^...^...^.^.^.....^.^...^...^.^.....^.^.^.^.^.^.^...^.....^.....\n\
   .............................................................................................................................................\n\
   ....^.^.^.^.^.^...^.^...^...........^.....^...^...^.^.^.^.^.^...^.....^.^...^.^.^...^.^...^...^.^.^...^.^...^.^.^...^.^...^...^.^.^.^...^....\n\
   .............................................................................................................................................\n\
   ...^.^...^.^.^.^.^.^.^...^.^.^.^...^.^...^.....^.^.^.^...^.^.....^.^.^.^.^...^.^...^.....^...^...^.....^.^...^.^.........^.^.^...^.^.^.^.^...\n\
   .............................................................................................................................................\n\
   ..^.^.^.....^.^.^.^.^...^.^.^.....^.^.^.^.^.^.^...^.....^.^.....^.^.....^.^...^.......^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^..\n\
   .............................................................................................................................................\n\
   .^.^.^.........^.^.^.....^.^.^.^.^...^.^...^...^.^.^.^.....^...^.^...^.^.^...^.^.....^.....^...^...^...^.^.....^...^.^...^.^.....^.^.^.^.^.^.\n\
   ............................................................................................................................................."
